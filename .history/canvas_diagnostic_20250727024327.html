<!DOCTYPE html>
<html>
<head>
    <title>Canvas Live Feed Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding: 20px; background: #1a1a1a; color: white; }
        .debug-panel { background: #2a2a2a; border: 1px solid #555; padding: 15px; margin: 10px 0; border-radius: 8px; }
        canvas { border: 2px solid lime; }
    </style>
</head>
<body>
    <h1>Live Feed Canvas Diagnostic</h1>
    
    <div class="debug-panel">
        <h3>Direct Canvas Test</h3>
        <canvas id="test-canvas" width="178" height="100" style="background: #000;"></canvas>
        <br><br>
        <button onclick="testCanvas()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Test Canvas Drawing</button>
        <button onclick="fetchAndDrawFrame()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-left: 10px;">Fetch & Draw Live Frame</button>
    </div>
    
    <div class="debug-panel">
        <h3>Canvas State Debug</h3>
        <div id="canvas-debug" style="font-family: monospace; font-size: 12px;"></div>
    </div>
    
    <div class="debug-panel">
        <h3>Image Element Test (for comparison)</h3>
        <img id="test-img" style="width: 178px; height: 100px; border: 2px solid orange; object-fit: cover;" alt="Test Image">
        <br><br>
        <button onclick="fetchAndShowInImg()" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Fetch & Show in IMG</button>
    </div>
    
    <div class="debug-panel">
        <h3>Debug Logs</h3>
        <div id="debug-logs" style="height: 200px; overflow-y: auto; background: #1a1a1a; padding: 10px; border: 1px solid #555; font-family: monospace; font-size: 12px;"></div>
    </div>
    
    <script>
        const debugLogs = document.getElementById('debug-logs');
        const canvasDebug = document.getElementById('canvas-debug');
        
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.innerHTML += `[${timestamp}] ${message}\n`;
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }
        
        function updateCanvasDebug() {
            const canvas = document.getElementById('test-canvas');
            const ctx = canvas.getContext('2d');
            
            canvasDebug.innerHTML = `
                Canvas Dimensions: ${canvas.width}x${canvas.height}<br>
                CSS Dimensions: ${canvas.offsetWidth}x${canvas.offsetHeight}<br>
                Canvas Style: ${canvas.style.cssText}<br>
                Context Available: ${!!ctx}<br>
                Image Smoothing: ${ctx ? ctx.imageSmoothingEnabled : 'N/A'}<br>
                Fill Style: ${ctx ? ctx.fillStyle : 'N/A'}<br>
            `;
        }
        
        function testCanvas() {
            log('üß™ Testing basic canvas drawing...');
            const canvas = document.getElementById('test-canvas');
            const ctx = canvas.getContext('2d');
            
            // Clear and draw test pattern
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(20, 20, 50, 30);
            
            ctx.fillStyle = '#0000FF';
            ctx.fillRect(100, 40, 50, 30);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = '12px Arial';
            ctx.fillText('Canvas Test', 10, 15);
            
            log('‚úÖ Basic canvas drawing completed');
            updateCanvasDebug();
        }
        
        async function fetchAndDrawFrame() {
            log('üîÑ Fetching live frame from API...');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/frame');
                const data = await response.json();
                
                log(`üìä API Response: success=${data.success}, hasFrame=${data.hasFrame}, dataLength=${data.frameData ? data.frameData.length : 0}`);
                
                if (data.success && data.hasFrame && data.frameData) {
                    const canvas = document.getElementById('test-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    log('üñºÔ∏è Creating image from frame data...');
                    const img = new Image();
                    
                    img.onload = () => {
                        log(`‚úÖ Image loaded: ${img.width}x${img.height}`);
                        
                        // Clear canvas with black background
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Calculate scaling
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        const scaledWidth = img.width * scale;
                        const scaledHeight = img.height * scale;
                        const x = (canvas.width - scaledWidth) / 2;
                        const y = (canvas.height - scaledHeight) / 2;
                        
                        // Draw the image
                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                        
                        log(`‚úÖ Frame drawn to canvas: scaled to ${Math.round(scaledWidth)}x${Math.round(scaledHeight)} at position (${Math.round(x)}, ${Math.round(y)})`);
                        updateCanvasDebug();
                    };
                    
                    img.onerror = (error) => {
                        log(`‚ùå Image load error: ${error}`);
                    };
                    
                    img.src = data.frameData;
                } else {
                    log(`‚ùå No valid frame data received`);
                }
                
            } catch (error) {
                log(`‚ùå Error fetching frame: ${error.message}`);
            }
        }
        
        async function fetchAndShowInImg() {
            log('üîÑ Fetching live frame for IMG element...');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/frame');
                const data = await response.json();
                
                if (data.success && data.hasFrame && data.frameData) {
                    const img = document.getElementById('test-img');
                    
                    img.onload = () => {
                        log('‚úÖ Frame loaded in IMG element successfully');
                    };
                    
                    img.onerror = (error) => {
                        log(`‚ùå IMG element load error: ${error}`);
                    };
                    
                    img.src = data.frameData;
                    log('‚úÖ Frame data assigned to IMG element');
                } else {
                    log(`‚ùå No valid frame data for IMG element`);
                }
                
            } catch (error) {
                log(`‚ùå Error fetching frame for IMG: ${error.message}`);
            }
        }
        
        // Initialize
        log('üöÄ Canvas diagnostic tool initialized');
        updateCanvasDebug();
        
        // Auto-update canvas debug every 2 seconds
        setInterval(updateCanvasDebug, 2000);
    </script>
</body>
</html>
