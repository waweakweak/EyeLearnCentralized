<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #005a8b;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .instructions {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ Countdown Timer Fix Test</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ Test Instructions:</h3>
            <ol>
                <li><strong>Test 1</strong>: Click "Test New Module" - should show 3-second countdown</li>
                <li><strong>Test 2</strong>: Click "Test Section Change" - should start immediately (no countdown)</li>
                <li><strong>Test 3</strong>: Click "Test Different Module" - should show countdown again</li>
                <li><strong>Test 4</strong>: Click "Test Same Module Again" - should start immediately</li>
            </ol>
            <p><strong>Expected Result:</strong> Countdown only appears when opening a new module for the first time, never when changing sections.</p>
        </div>

        <div class="status" id="status">
            Ready to test countdown behavior...
        </div>

        <div>
            <button onclick="testNewModule()">ğŸš€ Test New Module (Should Show Countdown)</button>
            <button onclick="testSectionChange()">ğŸ“ Test Section Change (No Countdown)</button>
            <button onclick="testDifferentModule()">ğŸ¯ Test Different Module (Should Show Countdown)</button>
            <button onclick="testSameModule()">ğŸ”„ Test Same Module Again (No Countdown)</button>
            <br>
            <button onclick="clearSession()" style="background: #ff5722;">ğŸ—‘ï¸ Clear Session Data</button>
            <button onclick="runFullTest()" style="background: #4caf50;">ğŸ§ª Run Full Automated Test</button>
        </div>

        <div id="results"></div>
    </div>

    <!-- Include the eye tracking system -->
    <script src="user/js/cv-eye-tracking.js"></script>

    <script>
        let currentTracker = null;

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            console.log(message);
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = message;
            results.appendChild(result);
        }

        async function testNewModule() {
            updateStatus('ğŸš€ Testing NEW MODULE - should show 3-second countdown...');
            
            // Stop current tracker if exists
            if (currentTracker) {
                await currentTracker.stopTracking();
            }
            
            // Clear session for this test to simulate new module entry
            sessionStorage.removeItem('eyetracking_countdown_999');
            
            // Create new tracker for a "new" module
            currentTracker = new CVEyeTrackingSystem(999, 1);
            
            addResult('ğŸš€ New module test initiated - watch for countdown notification!', 'warning');
            updateStatus('ğŸš€ New module tracker initialized - 3-second countdown should have appeared!');
        }

        async function testSectionChange() {
            updateStatus('ğŸ“ Testing SECTION CHANGE - should NOT show countdown...');
            
            // Stop current tracker if exists
            if (currentTracker) {
                await currentTracker.stopTracking();
            }
            
            // Create tracker for same module, different section (no countdown)
            currentTracker = new CVEyeTrackingSystem(999, 2);
            
            addResult('ğŸ“ Section change test completed - no countdown should have appeared!', 'success');
            updateStatus('ğŸ“ Section change completed - tracking should have started immediately!');
        }

        async function testDifferentModule() {
            updateStatus('ğŸ¯ Testing DIFFERENT MODULE - should show countdown...');
            
            // Stop current tracker if exists
            if (currentTracker) {
                await currentTracker.stopTracking();
            }
            
            // Clear session for different module
            sessionStorage.removeItem('eyetracking_countdown_888');
            
            // Create tracker for different module
            currentTracker = new CVEyeTrackingSystem(888, 1);
            
            addResult('ğŸ¯ Different module test initiated - watch for countdown notification!', 'warning');
            updateStatus('ğŸ¯ Different module tracker initialized - countdown should have appeared!');
        }

        async function testSameModule() {
            updateStatus('ğŸ”„ Testing SAME MODULE AGAIN - should NOT show countdown...');
            
            // Stop current tracker if exists
            if (currentTracker) {
                await currentTracker.stopTracking();
            }
            
            // Create tracker for same module again (countdown already shown)
            currentTracker = new CVEyeTrackingSystem(888, 3);
            
            addResult('ğŸ”„ Same module retest completed - no countdown should have appeared!', 'success');
            updateStatus('ğŸ”„ Same module again - tracking should have started immediately!');
        }

        function clearSession() {
            // Clear all eye tracking session data
            const keys = Object.keys(sessionStorage);
            keys.forEach(key => {
                if (key.startsWith('eyetracking_countdown_')) {
                    sessionStorage.removeItem(key);
                }
            });
            
            if (currentTracker) {
                currentTracker.stopTracking();
                currentTracker = null;
            }
            
            document.getElementById('results').innerHTML = '';
            updateStatus('ğŸ—‘ï¸ Session data cleared - ready for fresh tests');
            addResult('ğŸ—‘ï¸ All session data cleared - fresh start!', 'warning');
        }

        async function runFullTest() {
            addResult('ğŸ§ª Starting automated full test sequence...', 'warning');
            clearSession();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testNewModule();
            
            await new Promise(resolve => setTimeout(resolve, 4000)); // Wait for countdown
            await testSectionChange();
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            await testDifferentModule();
            
            await new Promise(resolve => setTimeout(resolve, 4000)); // Wait for countdown
            await testSameModule();
            
            addResult('ğŸ‰ Automated test sequence completed! Review results above.', 'success');
        }

        // Show initial status
        addResult('âœ… Countdown fix test page loaded successfully!', 'success');
        addResult('ğŸ“‹ Use the buttons above to test different scenarios', 'info');
    </script>
</body>
</html>
