<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Feed Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">Live Feed Test</h1>
        <p class="text-lg mb-4">Testing the fixed live video feed functionality</p>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Service Status -->
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Service Status</h2>
                <div id="service-status" class="space-y-2">
                    <div>Checking service...</div>
                </div>
                <button onclick="startTracking()" class="mt-4 bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    üöÄ Start Eye Tracking
                </button>
                <button onclick="testFrameAPI()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded ml-2">
                    üìπ Test Frame API
                </button>
            </div>

            <!-- Direct Frame Test -->
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Direct Frame Test</h2>
                <div class="bg-black rounded-lg p-4">
                    <img id="direct-frame" src="" alt="Direct Frame Test" 
                         class="w-full h-40 object-contain bg-gray-800 rounded"
                         style="min-height: 160px;">
                </div>
                <div id="frame-status" class="mt-2 text-sm text-gray-300">
                    Ready to test frame API...
                </div>
            </div>
        </div>

        <!-- Live Feed via Eye Tracking Interface -->
        <div class="mt-6 bg-white/10 backdrop-blur-sm rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Eye Tracking Interface Test</h2>
            <p class="text-sm text-gray-300 mb-4">
                The compact eye tracking interface should appear in the top-right corner with working live feed.
            </p>
            <div id="interface-status" class="text-sm">
                Click "Start Eye Tracking" to initialize the interface with live feed.
            </div>
        </div>
    </div>

    <script src="user/js/cv-eye-tracking.js"></script>
    <script>
        let tracker = null;
        let frameTestInterval = null;

        // Test service health on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkServiceHealth();
        });

        async function checkServiceHealth() {
            const statusDiv = document.getElementById('service-status');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <div class="text-green-400">‚úÖ Service Connected</div>
                        <div class="text-sm">Status: ${data.status}</div>
                        <div class="text-sm">Version: ${data.version || '2.0.0'}</div>
                        <div class="text-sm">Features: ${data.features ? data.features.length : 0} available</div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div class="text-red-400">‚ùå Service connection failed</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-400">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function startTracking() {
            const interfaceStatus = document.getElementById('interface-status');
            
            try {
                interfaceStatus.textContent = 'üöÄ Initializing eye tracking with live feed...';
                
                // Stop existing tracker
                if (tracker) {
                    await tracker.stopTracking();
                }
                
                // Create new tracker
                tracker = new CVEyeTrackingSystem('live_feed_test', 'section_1');
                
                interfaceStatus.innerHTML = `
                    <div class="text-green-400">‚úÖ Eye tracking initialized!</div>
                    <div class="text-sm">Look for the compact interface in the top-right corner with live feed.</div>
                `;
                
            } catch (error) {
                interfaceStatus.innerHTML = `<div class="text-red-400">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testFrameAPI() {
            const frameImg = document.getElementById('direct-frame');
            const frameStatus = document.getElementById('frame-status');
            
            try {
                frameStatus.textContent = 'üîÑ Fetching frame from API...';
                
                const response = await fetch('http://127.0.0.1:5000/api/frame');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.frame) {
                        frameImg.src = data.frame;
                        frameStatus.innerHTML = `
                            <div class="text-green-400">‚úÖ Frame loaded successfully</div>
                            <div class="text-xs">State: ${data.tracking_state}</div>
                            <div class="text-xs">Timestamp: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                        `;
                        
                        // Start auto-refresh for live updates
                        if (!frameTestInterval) {
                            frameTestInterval = setInterval(async () => {
                                try {
                                    const resp = await fetch('http://127.0.0.1:5000/api/frame');
                                    if (resp.ok) {
                                        const frameData = await resp.json();
                                        if (frameData.success && frameData.frame) {
                                            frameImg.src = frameData.frame;
                                        }
                                    }
                                } catch (e) {
                                    console.log('Frame refresh error:', e);
                                }
                            }, 500);
                        }
                        
                    } else {
                        frameStatus.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è No frame data available</div>';
                    }
                } else {
                    frameStatus.innerHTML = `<div class="text-red-400">‚ùå API error: ${response.status}</div>`;
                }
            } catch (error) {
                frameStatus.innerHTML = `<div class="text-red-400">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Stop frame test interval when page unloads
        window.addEventListener('beforeunload', () => {
            if (frameTestInterval) {
                clearInterval(frameTestInterval);
            }
        });
    </script>
</body>
</html>
