<!DOCTYPE html>
<html>
<head>
    <title>Module Live Feed Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding: 20px; background: #1a1a1a; color: white; }
        .debug-panel { background: #2a2a2a; border: 1px solid #555; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Module Live Feed Debug Test</h1>
    
    <div class="debug-panel">
        <h3>Service Status:</h3>
        <div id="service-status">Checking...</div>
    </div>
    
    <div class="debug-panel">
        <h3>Tracking Interface:</h3>
        <button onclick="createInterface()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Create Interface</button>
        <button onclick="testFrameLoad()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-left: 10px;">Test Frame Load</button>
    </div>
    
    <div class="debug-panel">
        <h3>Debug Logs:</h3>
        <div id="debug-logs" style="height: 300px; overflow-y: auto; background: #1a1a1a; padding: 10px; border: 1px solid #555; font-family: monospace; font-size: 12px;"></div>
    </div>
    
    <div class="debug-panel">
        <h3>Direct Image Test:</h3>
        <img id="direct-test-img" alt="Direct API Test" style="width: 320px; height: 240px; border: 2px solid #555; object-fit: cover;">
    </div>
    
    <script>
        const debugLogs = document.getElementById('debug-logs');
        
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.innerHTML += `[${timestamp}] ${message}\n`;
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }
        
        async function checkServiceStatus() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/health');
                const data = await response.json();
                document.getElementById('service-status').innerHTML = `‚úÖ Service Running: ${data.version || 'Unknown version'}`;
                log('‚úÖ Service health check passed');
                return true;
            } catch (error) {
                document.getElementById('service-status').innerHTML = `‚ùå Service Error: ${error.message}`;
                log('‚ùå Service health check failed: ' + error.message);
                return false;
            }
        }
        
        function createInterface() {
            log('üî® Creating tracking interface...');
            
            // Remove existing interface
            const existing = document.getElementById('cv-eye-tracking-interface');
            if (existing) {
                existing.remove();
                log('üóëÔ∏è Removed existing interface');
            }
            
            // Create the exact same interface as the module
            const trackingContainer = document.createElement('div');
            trackingContainer.id = 'cv-eye-tracking-interface';
            trackingContainer.innerHTML = \`
                <div class="fixed top-20 right-4 bg-black text-white shadow-2xl rounded-lg border border-gray-600 z-50" style="width: 180px; font-family: system-ui;">
                    <!-- Header with red dot and "Eye Tracking" -->
                    <div class="px-2 py-1.5 border-b border-gray-600">
                        <div class="flex items-center">
                            <div id="tracking-indicator" class="w-1.5 h-1.5 rounded-full bg-red-500 mr-1.5"></div>
                            <span class="text-xs font-medium">Eye Tracking</span>
                        </div>
                    </div>
                    
                    <!-- Focus status line -->
                    <div class="px-2 py-1 border-b border-gray-600">
                        <div class="flex items-center text-xs">
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></div>
                            <span id="focus-status">Focused</span>
                        </div>
                    </div>
                    
                    <!-- Metrics -->
                    <div class="px-2 py-1.5 text-xs space-y-0.5 border-b border-gray-600">
                        <div>Focus: <span id="focus-time" class="text-green-400">0</span>s</div>
                        <div>Session: <span id="session-time" class="text-white">0</span>s</div>
                        <div>Focused: <span id="focus-percentage" class="text-white">0</span>%</div>
                        <div>Unfocused: <span id="unfocus-time" class="text-white">0</span>s</div>
                    </div>
                    
                    <!-- Live Feed label -->
                    <div class="px-2 py-1 text-xs text-gray-300 border-b border-gray-600">
                        Live Feed
                    </div>
                    
                    <!-- Video feed container -->
                    <div class="relative bg-black">
                        <img id="tracking-video" src="" alt="Live Feed" 
                             style="width: 100%; height: 100px; object-fit: cover; display: block; border: 1px solid lime;"
                             class="rounded-b-lg">
                    </div>
                </div>
            \`;
            
            document.body.appendChild(trackingContainer);
            log('‚úÖ Interface created');
            
            // Verify creation
            setTimeout(() => {
                const videoElement = document.getElementById('tracking-video');
                log('üîç Video element check: ' + (videoElement ? 'FOUND' : 'NOT FOUND'));
                if (videoElement) {
                    log('üîç Video element dimensions: ' + videoElement.offsetWidth + 'x' + videoElement.offsetHeight);
                }
            }, 100);
        }
        
        async function testFrameLoad() {
            log('üîÑ Testing frame load...');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/frame');
                const data = await response.json();
                
                log('üìä API Response: ' + JSON.stringify({
                    success: data.success,
                    hasFrame: data.hasFrame,
                    frameDataLength: data.frameData ? data.frameData.length : 0
                }));
                
                if (data.frameData) {
                    log('üñºÔ∏è Frame data prefix: ' + data.frameData.substring(0, 50));
                    
                    // Test with the tracking video element
                    const trackingVideo = document.getElementById('tracking-video');
                    if (trackingVideo) {
                        log('üéØ Assigning to tracking video element...');
                        
                        trackingVideo.onload = () => {
                            log('‚úÖ Tracking video loaded successfully!');
                            trackingVideo.style.border = '2px solid lime';
                        };
                        trackingVideo.onerror = (error) => {
                            log('‚ùå Tracking video failed: ' + error);
                            trackingVideo.style.border = '2px solid red';
                        };
                        
                        trackingVideo.src = data.frameData;
                    } else {
                        log('‚ùå Tracking video element not found');
                    }
                    
                    // Also test with direct image
                    const directImg = document.getElementById('direct-test-img');
                    directImg.onload = () => {
                        log('‚úÖ Direct image loaded successfully!');
                        directImg.style.border = '2px solid green';
                    };
                    directImg.onerror = (error) => {
                        log('‚ùå Direct image failed: ' + error);
                        directImg.style.border = '2px solid red';
                    };
                    directImg.src = data.frameData;
                    
                } else {
                    log('‚ùå No frame data in response');
                }
                
            } catch (error) {
                log('‚ùå Error testing frame load: ' + error.message);
            }
        }
        
        // Initialize
        checkServiceStatus();
        log('üöÄ Debug test initialized');
        
        // Auto-refresh service status every 5 seconds
        setInterval(checkServiceStatus, 5000);
        
        // Auto-test frame loading every 3 seconds
        setInterval(() => {
            const trackingVideo = document.getElementById('tracking-video');
            if (trackingVideo) {
                testFrameLoad();
            }
        }, 3000);
    </script>
</body>
</html>
