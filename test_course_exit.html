<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Exit Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-2xl font-bold mb-4">Course Exit Test</h1>
        
        <!-- Simulate the module navigation with exit button -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold mb-4">Module Learning Environment</h2>
            
            <!-- Top navigation bar (similar to Smodulepart.php) -->
            <nav class="flex items-center justify-between p-4 bg-white shadow-md rounded mb-4">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-blue-600">EyeLearn</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Back to Dashboard Button -->
                    <button onclick="handleCourseExit()" class="text-gray-700 hover:text-blue-600 flex items-center mr-2 bg-transparent border-none cursor-pointer" data-manual-exit="true">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span>Back to Dashboard</span>
                    </button>
                </div>
            </nav>
            
            <div class="text-center">
                <p class="text-gray-600 mb-4">This is a test page to verify the course exit functionality.</p>
                <p class="text-sm text-gray-500">Click "Back to Dashboard" to test if the camera properly shuts down.</p>
                
                <div id="test-status" class="mt-4 p-4 bg-blue-50 rounded">
                    <p>ðŸ“¹ Eye tracking status: <span id="tracking-status">Not initialized</span></p>
                    <p>ðŸ”— Service connection: <span id="service-status">Checking...</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add URL parameters to simulate module environment -->
    <script>
        // Add module parameters to URL to trigger eye tracking
        if (!window.location.search.includes('module_id')) {
            const newUrl = window.location.href + '?module_id=1&section_id=1';
            window.history.replaceState({}, '', newUrl);
        }
    </script>

    <!-- Load CV Eye Tracking -->
    <script src="user/js/cv-eye-tracking.js"></script>
    
    <!-- Course Exit Handler -->
    <script>
        // Function to handle course exit - stops eye tracking and camera service
        async function handleCourseExit() {
            try {
                console.log('ðŸšª Handling course exit...');
                
                // Show loading indicator
                const exitButton = event.target.closest('button');
                if (exitButton) {
                    exitButton.innerHTML = `
                        <svg class="w-5 h-5 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Stopping...</span>
                    `;
                    exitButton.disabled = true;
                }
                
                // Update status
                document.getElementById('tracking-status').textContent = 'Stopping...';
                
                // Stop eye tracking service and camera
                if (typeof CVEyeTrackingSystem !== 'undefined') {
                    await CVEyeTrackingSystem.handleCourseExit();
                    document.getElementById('tracking-status').textContent = 'Stopped âœ…';
                } else {
                    console.log('âš ï¸ CVEyeTrackingSystem not available, proceeding with navigation');
                    document.getElementById('tracking-status').textContent = 'Not available';
                }
                
                // Show success message instead of navigating
                setTimeout(() => {
                    document.getElementById('test-status').innerHTML = `
                        <div class="text-green-600">
                            <p>âœ… Course exit test completed successfully!</p>
                            <p>ðŸ“¹ Camera service has been shut down</p>
                            <p>ðŸ’¾ Session data has been saved</p>
                            <p class="text-sm mt-2">In real environment, you would now be redirected to the dashboard.</p>
                        </div>
                    `;
                }, 1500); // 1.5 second delay to ensure shutdown completes
                
            } catch (error) {
                console.error('âŒ Error during course exit:', error);
                document.getElementById('tracking-status').textContent = 'Error: ' + error.message;
            }
        }

        // Check service status
        async function checkServiceStatus() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/status');
                if (response.ok) {
                    document.getElementById('service-status').textContent = 'Connected âœ…';
                } else {
                    document.getElementById('service-status').textContent = 'Not responding';
                }
            } catch (error) {
                document.getElementById('service-status').textContent = 'Not running';
            }
        }

        // Update tracking status
        function updateTrackingStatus() {
            if (window.cvEyeTracker) {
                const status = window.cvEyeTracker.isTracking ? 'Active âœ…' : 'Connected but not tracking';
                document.getElementById('tracking-status').textContent = status;
            } else {
                document.getElementById('tracking-status').textContent = 'Not initialized';
            }
        }

        // Check status periodically
        setInterval(() => {
            checkServiceStatus();
            updateTrackingStatus();
        }, 2000);

        // Initial check
        setTimeout(() => {
            checkServiceStatus();
            updateTrackingStatus();
        }, 1000);
    </script>
</body>
</html>
