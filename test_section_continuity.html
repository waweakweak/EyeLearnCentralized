<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Switch Service Continuity Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #005a8b;
        }
        button.success {
            background: #4caf50;
        }
        button.warning {
            background: #ff9800;
        }
        button.danger {
            background: #f44336;
        }
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .service-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        .service-running {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        .service-stopped {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }
        .service-unknown {
            background: #fff3e0;
            color: #f57c00;
            border: 2px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîÑ Section Switch Service Continuity Test</h1>
        
        <div class="status">
            <h3>üìã Test Objective:</h3>
            <p><strong>Verify that the eye tracking service continues running when switching sections within the same module.</strong></p>
            <p>Expected behavior: Countdown only on new modules, no service interruption on section changes.</p>
        </div>

        <div>
            <h3>üéÆ Service Controls:</h3>
            <button onclick="startNewModule()" class="success">üöÄ Start New Module (Module 100)</button>
            <button onclick="switchToSection2()" class="warning">üìù Switch to Section 2</button>
            <button onclick="switchToSection3()" class="warning">üìù Switch to Section 3</button>
            <button onclick="switchToSection1()" class="warning">üìù Back to Section 1</button>
            <br>
            <button onclick="startDifferentModule()" class="success">üéØ Start Different Module (Module 200)</button>
            <button onclick="checkServiceStatus()">üìä Check Service Status</button>
            <button onclick="clearLog()" class="danger">üóëÔ∏è Clear Log</button>
        </div>

        <div>
            <h3>üìä Service Status:</h3>
            <div id="service-status" class="service-status service-unknown">Checking...</div>
            <div id="current-module">Module: Unknown</div>
            <div id="current-section">Section: Unknown</div>
        </div>

        <div>
            <h3>üìù Test Log:</h3>
            <div id="log" class="log">Initializing test environment...\n</div>
        </div>

        <div class="status">
            <h3>‚úÖ Expected Results:</h3>
            <ol>
                <li><strong>New Module Start:</strong> Shows countdown, service starts ‚úÖ</li>
                <li><strong>Section 2 Switch:</strong> No countdown, service continues ‚úÖ</li>
                <li><strong>Section 3 Switch:</strong> No countdown, service continues ‚úÖ</li>
                <li><strong>Back to Section 1:</strong> No countdown, service continues ‚úÖ</li>
                <li><strong>Different Module:</strong> Shows countdown, restarts service ‚úÖ</li>
            </ol>
        </div>
    </div>

    <!-- Include the eye tracking system -->
    <script src="user/js/cv-eye-tracking.js"></script>

    <script>
        let currentTracker = null;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateServiceStatus(status, module, section) {
            const statusElement = document.getElementById('service-status');
            const moduleElement = document.getElementById('current-module');
            const sectionElement = document.getElementById('current-section');
            
            statusElement.className = 'service-status';
            
            if (status === 'running') {
                statusElement.classList.add('service-running');
                statusElement.textContent = 'üü¢ Service Running';
            } else if (status === 'stopped') {
                statusElement.classList.add('service-stopped');
                statusElement.textContent = 'üî¥ Service Stopped';
            } else {
                statusElement.classList.add('service-unknown');
                statusElement.textContent = 'üü° Status Unknown';
            }
            
            moduleElement.textContent = `Module: ${module || 'Unknown'}`;
            sectionElement.textContent = `Section: ${section || 'Unknown'}`;
        }

        async function startNewModule() {
            log('üöÄ Starting new module (Module 100) - should show countdown');
            
            // Clear any existing tracker
            if (currentTracker) {
                await currentTracker.stopTracking();
                currentTracker = null;
            }
            
            // Clear session storage for module 100 to trigger countdown
            sessionStorage.removeItem('eyetracking_countdown_100');
            
            // Start new tracker
            currentTracker = new CVEyeTrackingSystem(100, 1);
            updateServiceStatus('running', 100, 1);
            
            log('‚úÖ New module started - countdown should have appeared');
            
            // Check status after initialization
            setTimeout(checkServiceStatus, 4000);
        }

        async function switchToSection2() {
            log('üìù Switching to Section 2 - should NOT show countdown');
            
            if (!currentTracker) {
                log('‚ùå No active tracker - start a module first');
                return;
            }
            
            await currentTracker.switchSection(2);
            updateServiceStatus('running', currentTracker.moduleId, 2);
            
            log('‚úÖ Switched to Section 2 - service should continue running');
            
            setTimeout(checkServiceStatus, 1000);
        }

        async function switchToSection3() {
            log('üìù Switching to Section 3 - should NOT show countdown');
            
            if (!currentTracker) {
                log('‚ùå No active tracker - start a module first');
                return;
            }
            
            await currentTracker.switchSection(3);
            updateServiceStatus('running', currentTracker.moduleId, 3);
            
            log('‚úÖ Switched to Section 3 - service should continue running');
            
            setTimeout(checkServiceStatus, 1000);
        }

        async function switchToSection1() {
            log('üìù Switching back to Section 1 - should NOT show countdown');
            
            if (!currentTracker) {
                log('‚ùå No active tracker - start a module first');
                return;
            }
            
            await currentTracker.switchSection(1);
            updateServiceStatus('running', currentTracker.moduleId, 1);
            
            log('‚úÖ Switched back to Section 1 - service should continue running');
            
            setTimeout(checkServiceStatus, 1000);
        }

        async function startDifferentModule() {
            log('üéØ Starting different module (Module 200) - should show countdown');
            
            // Stop current tracker
            if (currentTracker) {
                await currentTracker.stopTracking();
                currentTracker = null;
                updateServiceStatus('stopped', null, null);
            }
            
            // Clear session storage for module 200 to trigger countdown
            sessionStorage.removeItem('eyetracking_countdown_200');
            
            // Start different module
            currentTracker = new CVEyeTrackingSystem(200, 1);
            updateServiceStatus('running', 200, 1);
            
            log('‚úÖ Different module started - countdown should have appeared');
            
            setTimeout(checkServiceStatus, 4000);
        }

        async function checkServiceStatus() {
            log('üìä Checking service status...');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/status');
                const status = await response.json();
                
                if (status.status === 'tracking') {
                    log(`‚úÖ Service is running - Module: ${status.module_id}, Section: ${status.section_id}`);
                    updateServiceStatus('running', status.module_id, status.section_id);
                } else {
                    log(`‚ö†Ô∏è Service status: ${status.status}`);
                    updateServiceStatus('stopped', null, null);
                }
                
                if (currentTracker) {
                    log(`üéØ Frontend tracker - Module: ${currentTracker.moduleId}, Section: ${currentTracker.sectionId}`);
                }
                
            } catch (error) {
                log(`‚ùå Failed to check service status: ${error.message}`);
                updateServiceStatus('unknown', null, null);
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
            log('üóëÔ∏è Log cleared - ready for new tests');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('‚úÖ Test environment initialized');
            log('üìã Use the buttons above to test section switching behavior');
            log('üéØ Goal: Verify service continues running during section changes');
            
            // Initial status check
            setTimeout(checkServiceStatus, 1000);
        });

        // Auto-refresh status every 10 seconds
        setInterval(checkServiceStatus, 10000);
    </script>
</body>
</html>
